import t from"axios";import e from"https";class s{constructor(){this.pipeline=[]}addPipeline(t){return this.pipeline.push(t),this}runPipeline(t){return this.pipeline.reduce(((t,e)=>e(t)),t)}}class i{constructor(t,e,i){this.host="",this.marked={table_start:0,row_start:0},this.pipeline=e||new s,this.host=t,this.marked=i||this.marked}async fetchData(){try{const s=t.create({httpsAgent:new e.Agent({rejectUnauthorized:!1})});return(await s.get(this.host,{params:this.mapping()})).data}catch(t){return console.error("Error fetching data:",t.message),null}}async craw(){const t=await this.fetchData();if(t){const e=function(t){return[...t.matchAll(/<tr(?:.|\n)*?>((?:.|\n)*?)<\/tr>/g)].map((t=>t[1]))}([...t.matchAll(/<table(?:.|\n)*?>((?:.|\n)*?)<\/table>/g)].map((t=>t[1]))[this.marked.table_start]).slice(this.marked.row_start).map((t=>{const e=function(t){return[...t.matchAll(/<td(?:.|\n)*?>((?:.|\n)*?)<\/td>/g)].map((t=>t[1]))}(t);return this.parse(e)})).filter((t=>!!t));return this.pipeline.runPipeline(e)}return[]}}const n=class t extends i{constructor(e,s){super(t.DefaultHost,s,{table_start:3,row_start:1}),this.options=e||{}}mapping(){return{slt_namhoc:this.options.semester,slt_mamonhoc_filter:this.options.subjectCode,slt_monhoc_filter:this.options.subjectName,slt_malopmonhoc_filter:this.options.subjectClassCode,slt_giaovien_filter:this.options.teacher,slt_thu_filter:this.options.dayOfWeek,slt_giangduong_filter:this.options.lectureHall}}parse(t){if(12===t.length)return{subjectCode:t[1],subjectName:t[2],credit:Number(t[3]),subjectClassCode:t[4],teacher:t[5],numStudent:Number(t[6]),sessionOfDay:t[7],dayOfWeek:t[8],session:this.parseSession(t[9]),lectureHall:t[10],group:t[11]}}parseSession(t){return t.split("-").map((t=>parseInt(t)))}};n.DefaultHost="http://112.137.129.115/tkb/listbylist.php";let r=n;const o=class t extends i{constructor(e,s){super(t.DefaultHost,s,{table_start:0,row_start:2}),this.options=e||{}}mapping(){return{"SinhvienLmh[masvTitle]":this.options.sid,"SinhvienLmh[hotenTitle]":this.options.name,"SinhvienLmh[ngaysinhTitle]":this.options.dob,"SinhvienLmh[lopkhoahocTitle]":this.options.officialClass,"SinhvienLmh[tenlopmonhocTitle]":this.options.subjectCode,"SinhvienLmh[tenmonhocTitle]":this.options.subjectName,"SinhvienLmh[nhom]":this.options.group,"SinhvienLmh[sotinchiTitle]":this.options.credit,"SinhvienLmh[ghichu]":this.options.note,"SinhvienLmh[term_id]":this.options.semester}}parse(t){if(11===t.length)return{student:{sid:t[1],name:t[2],dob:new Date(t[3].replace(/(\d{2})\/(\d{2})\/(\d{4})/,"$2/$1/$3")),officialClass:t[4]},subjectCode:t[5],subjectName:t[6],group:t[7],credit:parseInt(t[8]),note:t[9],semester:t[10]}}};o.DefaultHost="https://112.137.129.87/qldt/";let a=o;class h extends s{constructor(){super()}addAggregateBySID(){return this.pipeline.push((t=>{const e=t.reduce(((t,e)=>{const{student:s,...i}=e,n=s.sid;return t[n]?t[n].subjects.push({...i}):t[n]={student:s,subjects:[{...i}]},t}),{});return Object.values(e)})),this}}class p extends s{constructor(){super()}addAggregateBySubjectClassCode(){return this.pipeline.push((t=>t.reduce(((t,e)=>{const{subjectClassCode:s,...i}=e;return t[s]?t[s].push({...i}):t[s]=[i],t}),{}))),this}addFilterByGroup(t){return this.pipeline.push((e=>{const s=Object.values(e).map((e=>e.filter((e=>e.group===t||"CL"===e.group))));return Object.keys(e).map(((t,e)=>({[t]:s[e]})))})),this}}export{r as Calendar,p as CalendarPipeline,a as Subject,h as SubjectPipeline};
